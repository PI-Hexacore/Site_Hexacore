<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notificações - Hexacore</title>
  <link rel="stylesheet" href="slack.css" />
</head>

<body>

  <div class="container">
    <div class="sidebar">
      <div class="logo"></div>

      <div class="ola">
        <div id="infoNome" class="infoUsuario"></div>
      </div>

      <div class="direcionamentos">
        <div class="direcionamentosnav">
          <a href="../dashboard.html"><img src="../../assets/dash.png" alt="">Dashboard</a>
        </div>
      </div>

      <div class="direcionamentos">
        <div class="direcionamentosnav">
          <a href="../artistas/artistas.html"><img src="../../assets/artistas.png" alt="">Artistas</a>
        </div>
      </div>

      <div class="direcionamentos">
        <div class="direcionamentosnav"><a href="../perfil/perfil.html"> <img src="../../assets/perfil.png"
              alt="">Perfil</a>
        </div>
      </div>

      <div class="direcionamentos">
        <div class="direcionamentosnav active">
          <a href="slack.html"><img src="../../assets/notificacao.png" alt="">Notificações</a>
        </div>
      </div>

      <div class="direcionamentos" style="margin-top:auto;">
        <div class="direcionamentosnav">
          <a onclick="limparSessao()" href="../../login.html"><img src="../../assets/sair.png" alt="">Sair da Conta</a>
        </div>
      </div>
    </div>
  </div>

  <div class="main-content">
    <header class="header">
      <h1>NOTIFICAÇÕES</h1>
      <p>Configure suas notificações</p>
    </header>

    <section class="notificacoes-area">

      <div class="top-row">
        <div class="dropdown filtro-card">
          <div id="dropdownContent" class="dropdown-content" role="region" aria-label="Canais Slack">
            <p class="titulo-canais">Notificações disponíveis:</p>

            <label class="opcao-canal">
              <input type="checkbox" checked name="canais" value="País">
              País
            </label>

            <label class="opcao-canal">
              <input type="checkbox" checked name="canais" value="Música">
              Música
            </label>

            <label class="opcao-canal">
              <input type="checkbox" checked name="canais" value="Artista">
              Artista
            </label>
          </div>

        </div>

        <div class="acoes">
          <button id="btnToggle" class="btn">Desativar notificações</button>

          <button id="btnSalvar" class="btn config">
            Salvar configurações
          </button>
        </div>

      </div>

      <div id="feed" class="feed">
      </div>



    </section>

  </div>
</body>

</html>

<script>
  const canaisCheckboxes = Array.from(document.querySelectorAll('.opcao-canal input'));
  const btnToggle = document.getElementById("btnToggle");
  let ativo = true;

  function getCheckbox(value) {
    return canaisCheckboxes.find((c) => c.value === value);
  }

  function atualizarUI(config) {
    ativo = !!config.ativo;
    btnToggle.textContent = ativo ? "Desativar notificações" : "Ativar notificações";

    const pais = getCheckbox("País");
    const musica = getCheckbox("Música");
    const artista = getCheckbox("Artista");

    if (pais) pais.checked = !!config.receber_pais;
    if (musica) musica.checked = !!config.receber_musica;
    if (artista) artista.checked = !!config.receber_artista;

    // Se desativado, desmarca tudo visualmente (opcional)
    const disabled = !ativo;
    canaisCheckboxes.forEach(c => c.disabled = disabled);
  }

  async function carregarConfigSlack() {
    const idUsuario = sessionStorage.ID_USUARIO;
    if (!idUsuario) return;

    try {
      const resp = await fetch("/slack", {
        headers: { "x-user-id": idUsuario }
      });
      if (!resp.ok) throw new Error("Falha ao carregar config.");
      const payload = await resp.json();
      atualizarUI(payload.data || {});
    } catch (e) {
      console.error("Erro ao carregar config Slack:", e);
    }
  }

  btnToggle.addEventListener("click", () => {
    ativo = !ativo;
    btnToggle.textContent = ativo ? "Desativar notificações" : "Ativar notificações";
    // opcional: desabilitar checkboxes quando desativado
    canaisCheckboxes.forEach(c => c.disabled = !ativo);
  });

  document.getElementById("btnSalvar").addEventListener("click", async () => {
    const idUsuario = sessionStorage.ID_USUARIO;
    if (!idUsuario) return;

    const receber_pais = getCheckbox("País")?.checked ? 1 : 0;
    const receber_musica = getCheckbox("Música")?.checked ? 1 : 0;
    const receber_artista = getCheckbox("Artista")?.checked ? 1 : 0;

    try {
      const resp = await fetch("/slack/configurar", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "x-user-id": idUsuario
        },
        body: JSON.stringify({
          notificacoes_desativadas: ativo ? 0 : 1,
          receber_pais,
          receber_musica,
          receber_artista
        })
      });
      if (!resp.ok) throw new Error("Falha ao salvar config.");
      const payload = await resp.json();
      atualizarUI(payload.data || {});
      alert("Configurações salvas com sucesso!");
    } catch (e) {
      console.error("Erro ao salvar config Slack:", e);
      alert("Falha ao salvar configurações.");
    }
  });

  window.addEventListener("load", carregarConfigSlack);
</script>