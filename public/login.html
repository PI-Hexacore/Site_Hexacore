<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | HexaCore</title>
    <link rel="stylesheet" href="./css/cadastro.css">
    <link rel="shortcut icon" href="./assets/imagens/hexacore.png">


</head>

<body>

  <header class="nav">
    <div class="container-nav">
      <div class="logo" onclick="window.location.href='index.html'" style="cursor: pointer;">
        <img src="./assets/imagens/hexacore.png">
        <p>Hexacore</p>
      </div>

      <div class="botoes">
        <button class="botao entrar" onclick="window.location.href='login.html'">Entrar</button>
        <button class="botao cadastrar" onclick="window.location.href='cadastro.html'">Cadastrar</button>
      </div>
    </div>
  </header>

  <video autoplay muted loop class="lg-video">
    <source src="./assets/videos/video-login-hexacore.mp4" type="video/mp4">
  </video>
  
    <section class="container">

    <button class="btn-voltar" onclick="window.location.href='index.html'">←</button>
    <h1 class="titulo">Login</h1>

    <div class="form-box">

      <div class="form">
        <label for="login-email">E-mail empresarial:</label>
        
        <input type="email" id="login_email" class="input">

        <label for="login-senha">Senha:</label>
        
        <input type="password" id="login_senha" class="input"> 

        <button class="btn" onclick="entrar()">Logar</button>
      </div>

    </div>

  </section>
</body>

</html>
<script>
    function entrar() {

        var emailVar = login_email.value;
        var senhaVar = login_senha.value;

        if (emailVar == "" || senhaVar == "") {
            return false;
        }

        console.log("FORM LOGIN: ", emailVar);
        console.log("FORM SENHA: ", senhaVar);

        fetch("/empresas/autenticar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                emailEmp: emailVar,
                senhaEmp: senhaVar
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);

                    // Buscar dados completos da empresa e endereço
                    const idUsuario = json.id;
                    Promise.all([
                        fetch(`/empresas/buscar/${idUsuario}`),
                        fetch(`/endereco/buscar/${idUsuario}`)
                    ]).then(async ([resEmpresa, resEndereco]) => {
                        const empresaData = await resEmpresa.json();
                        const enderecoData = await resEndereco.json();

                        // Armazenar tudo no sessionStorage
                        sessionStorage.ID_USUARIO = idUsuario;
                        sessionStorage.EMAIL_USUARIO = empresaData[0].email;
                        sessionStorage.NOME_USUARIO = empresaData[0].nomeFantasia;
                        sessionStorage.RAZAO_SOCIAL = empresaData[0].razaoSocial;
                        sessionStorage.CNPJ = empresaData[0].cnpj;
                        sessionStorage.TELEFONE = empresaData[0].telefone;

                        if (enderecoData && enderecoData.length > 0) {
                            sessionStorage.CEP = enderecoData[0].cep;
                            sessionStorage.LOGRADOURO = enderecoData[0].logradouro;
                            sessionStorage.NUMERO = enderecoData[0].numero;
                            sessionStorage.BAIRRO = enderecoData[0].bairro;
                            sessionStorage.CIDADE = enderecoData[0].cidade;
                            sessionStorage.UF = enderecoData[0].uf;
                        }

                        window.location = "./dashboard/dashboard.html";
                    });

                });

            } else {

                console.log("Houve um erro ao tentar realizar o login!");

                resposta.text().then(texto => {
                    console.error(texto);
                    alert("Email ou senha inválidos!"); // Adiciona feedback para o usuário
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }

</script>